<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Мой первый портфель — MOEX ТОП-10 + Симулятор + Тест (20)</title>
  <meta name="description" content="Учебный симулятор: реальные котировки MOEX ТОП-10, портфельный тренажёр, теория и тест на 20 вопросов.">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React из CDN + Babel для JSX без сборки -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* тонкие улучшения скролла/печати */
    html{scroll-behavior:smooth}
    @media print {.no-print{display:none!important}}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    /* ===================== Конфиг ===================== */
    const TICKERS = [
      { secid:"SBER", name:"Сбербанк",      bcs:"https://bcs-express.ru/kotirovki-i-grafiki/sber" },
      { secid:"ROSN", name:"Роснефть",      bcs:"https://bcs-express.ru/kotirovki-i-grafiki/rosn" },
      { secid:"LKOH", name:"Лукойл",        bcs:"https://bcs-express.ru/kotirovki-i-grafiki/lkoh" },
      { secid:"NVTK", name:"Новатэк",       bcs:"https://bcs-express.ru/kotirovki-i-grafiki/nvtk" },
      { secid:"GAZP", name:"Газпром",       bcs:"https://bcs-express.ru/kotirovki-i-grafiki/gazp" },
      { secid:"PLZL", name:"Полюс",         bcs:"https://bcs-express.ru/kotirovki-i-grafiki/plzl" },
      { secid:"SIBN", name:"Газпром нефть", bcs:"https://bcs-express.ru/kotirovki-i-grafiki/sibn" },
      { secid:"GMKN", name:"Норникель",     bcs:"https://bcs-express.ru/kotirovki-i-grafiki/gmkn" },
      { secid:"YDEX", name:"Яндекс",        bcs:"https://bcs-express.ru/kotirovki-i-grafiki/ydex" },
      { secid:"TATN", name:"Татнефть",      bcs:"https://bcs-express.ru/kotirovki-i-grafiki/tatn" },
    ];

    // 20 вопросов: базовые понятия РЦБ, доходности, индексы, котировки, риск/диверсификация
    const QUIZ = [
      { q:"Что такое ценная бумага по ГК РФ?", a:["Документ строгой отчётности","Именной финансовый инструмент","Документ, удостоверяющий имущественные права, реализация которых возможна только при его предъявлении","Договор между инвестором и эмитентом"], i:2, why:"Ключевой признак — реализация прав при предъявлении бумаги." },
      { q:"Акция — это…", a:["Долговая расписка эмитента","Доля участия в капитале компании","Производный инструмент","Купон по облигации"], i:1, why:"Акция подтверждает право собственности на долю компании." },
      { q:"Облигация — это…", a:["Доля участия в капитале","Долговой инструмент с возвратом номинала","Паи индексного фонда","Фьючерсный контракт"], i:1, why:"Облигация — займ эмитенту с выплатой дохода и возвратом номинала." },
      { q:"Что показывает фондовый индекс (например, IMOEX)?", a:["Среднюю дивидендную доходность","Изменение совокупной стоимости набора акций","Ставку ЦБ РФ","Объём торгов на бирже"], i:1, why:"Индекс отражает динамику корзины акций." },
      { q:"Котировка ‘SBER 312,50 ₽ +0,8%’ означает:", a:["Цена выросла на 0,8% к началу года","Цена выросла на 0,8% к предыдущему закрытию","Цена выше на 0,8% относительно номинала","Рост на 0,8% за час"], i:1, why:"Изменение указывается к предыдущей цене закрытия." },
      { q:"Диверсификация — это…", a:["Покупка одной самой сильной акции","Распределение вложений для снижения риска","Торговля внутри дня","Страхование портфеля деривативами"], i:1, why:"Смысл — распределение между активами и отраслями." },
      { q:"Что такое купон?", a:["Выплата дохода по облигации","Премия по опциону","Ежеквартальный дивиденд","Комиссия брокера"], i:0, why:"Купон — процентный доход по облигации." },
      { q:"ETF — это…", a:["Закрытый ПИФ","Фонд, торгуемый на бирже, следящий за индексом/стратегией","Фьючерс на индекс","Бумага, дающая право на льготный НДФЛ"], i:1, why:"ETF — биржевой фонд с прозрачной стратегией." },
      { q:"Ликвидность актива — это…", a:["Его доходность за год","Способность быстро купить/продать по близкой к рынку цене","Объём дивидендов","Кредитный рейтинг эмитента"], i:1, why:"Ликвидность = быстрота сделки без сильного отклонения цены." },
      { q:"Риск-премия — это…", a:["Премия брокеру","Надбавка доходности за принятие большего риска","Вознаграждение маркет-мейкеру","Гарантированный доход по облигации"], i:1, why:"Инвестор ожидает бОльшую доходность за риск." },
      { q:"Ребалансировка портфеля — это…", a:["Продажа всех бумаг","Доведение долей активов до целевых","Смена брокера","Отказ от дивидендов"], i:1, why:"Периодическое выравнивание долей к стратегиям." },
      { q:"Куда отнести фьючерсы и опционы?", a:["К основным ценным бумагам","К производным финансовым инструментам (деривативам)","К банковским продуктам","К криптоактивам"], i:1, why:"Это деривативы — договоры на будущую поставку/расчёт." },
      { q:"Доходность по облигации при покупке по 98% от номинала и погашении по 100% без купонов:", a:["≈+2%","0%","−2%","Зависит от инфляции"], i:0, why:"Прирост к номиналу — скидка 2% становится доходом." },
      { q:"Что означает ‘дивидендная отсечка’?", a:["Дата выплаты денег","Дата, после которой покупатель не получает ближайший дивиденд","Дата собрания акционеров","Дата первой продажи акции"], i:1, why:"Эк-дата — кто купил после, ближайший дивиденд не получает." },
      { q:"Маржин-колл — это…", a:["Сигнал о недостаточности обеспечения при торговле с плечом","Ограничение на акции ‘голубых фишек’","Комиссия биржи","Просьба закрыть счёт"], i:0, why:"Брокер требует довнести обеспечение или закрыть позиции." },
      { q:"Если корреляция двух активов низкая/отрицательная, то…", a:["Риск портфеля выше","Риск портфеля ниже при той же доходности","Разницы нет","Доходность падает до нуля"], i:1, why:"Диверсификационный эффект снижает риск." },
      { q:"Что такое ‘спрэд’?", a:["Разница между лучшими ценами покупки и продажи","Годовая доходность","Комиссия депозитария","Штраф за досрочную продажу"], i:0, why:"Bid-Ask spread — показатель ликвидности." },
      { q:"Лучшее описание ‘индекса волатильности’:", a:["Средняя дивидендная ставка","Оценка ожидаемой изменчивости рынка","Индекс облигаций","Курс валют"], i:1, why:"Индикатор ‘нервности’ рынка." },
      { q:"Что означает ‘T+2’ на бирже?", a:["Сделка расчётами через два рабочих дня","Торговля во второй половине дня","Комиссия 2%","Плечо 2"], i:0, why:"Стандарт расчётов по акциям в РФ — два рабочих дня." },
      { q:"Что важно для долгосрочного инвестора?", a:["Часовой график","Краткосрочный шум","Состав портфеля, дисциплина и издержки","Только прогноз аналитика"], i:2, why:"Ключ — стратегия, диверсификация, контроль комиссий." },
    ];

    const fmtCur = n => n.toLocaleString('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:2});
    const fmtPct = x => (x>=0?'+':'') + (x*100).toFixed(2) + '%';

    /* ===================== Приложение ===================== */
    function App(){
      const [tab,setTab] = React.useState('market'); // market | sim | learn | quiz | about
      const [asOf, setAsOf] = React.useState('');
      const [err, setErr] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [quotes, setQuotes] = React.useState(TICKERS.map(t=>({...t, last:null, chgPct:null})));

      // Симулятор
      const [running, setRunning] = React.useState(true);
      const [cash, setCash] = React.useState(100_000);
      const [pos, setPos] = React.useState({}); // {SBER:{qty,avg}}
      const [sim, setSim] = React.useState([]);  // [{secid,name,price,path:[]}]
      const equity = React.useMemo(()=> sim.reduce((s,a)=> s + ((pos[a.secid]?.qty||0) * a.price),0),[sim,pos]);
      const total = cash + equity;
      const ret = (total - 100_000)/100_000;

      // ======= Цены MOEX ISS
      async function loadPrices(){
        try{
          setLoading(true); setErr('');
          const list = TICKERS.map(t=>t.secid).join(',');
          const url = `https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities.json?iss.meta=off&iss.only=marketdata,securities&securities=${list}`;
          const r = await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
          const j = await r.json();
          const cols = j.marketdata.columns, data = j.marketdata.data;
          const iSEC=cols.indexOf('SECID'), iLAST=cols.indexOf('LAST'), iPCT=cols.indexOf('LASTCHANGEPRCNT'), iLTPR=cols.indexOf('LASTTOPREVPRICE');
          const map = new Map();
          for(const row of data){
            const sec = row[iSEC], last=row[iLAST];
            const pct = iPCT>=0? row[iPCT] : (iLTPR>=0&&row[iLTPR]!=null? (row[iLTPR]-1)*100:null);
            map.set(sec,{last,pct});
          }
          const q = TICKERS.map(t=>({...t,last:map.get(t.secid)?.last??null, chgPct:map.get(t.secid)?.pct??null}));
          setQuotes(q);
          setAsOf(new Date().toLocaleString('ru-RU'));

          // инициализация симулятора реальными ценами
          setSim(prev=>{
            if(prev.length) return prev;
            return q.map(t=>{
              const p=t.last??100;
              return {secid:t.secid,name:t.name,price:p,path:[{x:0,y:p}]};
            });
          });
        }catch(e){ console.error(e); setErr('Не удалось получить котировки с MOEX ISS. Попробуйте ещё раз.'); }
        finally{ setLoading(false); }
      }
      React.useEffect(()=>{ loadPrices(); },[]);

      // ======= Тики симулятора: ±0.2% вокруг текущей
      React.useEffect(()=>{
        if(!running || sim.length===0) return;
        const id=setInterval(()=>{
          setSim(prev => prev.map(a=>{
            const shock = (Math.random()*2 - 1) * 0.002; // ±0.2%
            const next = Math.max(0.01, a.price*(1+shock));
            const nextPath = [...a.path, {x:(a.path[a.path.length-1].x+1), y:next}].slice(-120);
            return {...a, price:+next.toFixed(2), path:nextPath};
          }));
        }, 1200);
        return ()=>clearInterval(id);
      },[running, sim.length]);

      // ======= Торговля
      function trade(secid, side, qtyInput){
        const a = sim.find(x=>x.secid===secid); if(!a) return;
        const qty = Math.max(1, Math.floor(Number(qtyInput)||1));
        if(side==='buy'){
          const cost = qty*a.price; if(cost>cash) return;
          setCash(c=>c-cost);
          setPos(p=>{
            const cur=p[secid]||{qty:0,avg:a.price};
            const nqty=cur.qty+qty, navg=(cur.qty*cur.avg+qty*a.price)/nqty;
            return {...p,[secid]:{qty:nqty,avg:+navg.toFixed(2)}};
          });
        }else{
          setPos(p=>{
            const cur=p[secid]; if(!cur || cur.qty<qty) return p;
            setCash(c=>c+qty*a.price);
            const nqty=cur.qty-qty;
            if(nqty===0){ const{[secid]:_,...rest}=p; return rest; }
            return {...p,[secid]:{qty:nqty,avg:cur.avg}};
          });
        }
      }
      function resetSim(){ setCash(100_000); setPos({}); }

      // ======= Тест (20 вопросов)
      const [answers,setAnswers]=React.useState(Array(QUIZ.length).fill(null));
      const [showResult,setShowResult]=React.useState(false);
      const correctCount = answers.reduce((s,a,i)=> s + (a===QUIZ[i].i?1:0),0);
      const progress = Math.round(answers.filter(v=>v!==null).length/QUIZ.length*100);

      function exportCSV(){
        const rows=[["Тикер","Компания","Кол-во","Средняя","Текущая","Нереализ. P&L"]];
        sim.forEach(a=>{
          const p=pos[a.secid]; if(p?.qty){
            const pnl=p.qty*(a.price-p.avg);
            rows.push([a.secid,a.name,p.qty,p.avg,a.price,pnl.toFixed(2)]);
          }
        });
        rows.push([]); rows.push(["Кэш",cash.toFixed(2)]);
        rows.push(["Инвестировано",equity.toFixed(2)]);
        rows.push(["Стоимость портфеля",total.toFixed(2)]);
        rows.push(["Доходность",(ret*100).toFixed(2)+"%"]);
        const csv = rows.map(r=> r.map(v=> `"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
        const blob=new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='portfolio_export.csv'; a.click(); URL.revokeObjectURL(url);
      }
      function exportQuiz(){
        const lines=[];
        lines.push(`Тест «Рынок ценных бумаг»: ${correctCount}/${QUIZ.length} (${Math.round(correctCount/QUIZ.length*100)}%)`);
        lines.push("");
        QUIZ.forEach((q,idx)=>{
          const u=answers[idx]; const ok = u===q.i;
          lines.push(`${idx+1}. ${q.q}`);
          lines.push(`   Ваш ответ: ${u!==null? q.a[u]:"—"}`);
          lines.push(`   Верно: ${q.a[q.i]}`);
          lines.push(`   Пояснение: ${q.why}`);
          lines.push(`   Результат: ${ok?"верно":"ошибка"}`);
          lines.push("");
        });
        const blob=new Blob([lines.join('\n')],{type:"text/plain;charset=utf-8;"}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='quiz_result.txt'; a.click(); URL.revokeObjectURL(url);
      }

      return (
        <div className="min-h-screen">
          {/* ШАПКА */}
          <header className="sticky top-0 z-20 bg-white/90 backdrop-blur border-b">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
              <div>
                <div className="text-xs text-gray-500">Дисциплина: Финансы, денежное обращение и кредит — Тема: инвестиции</div>
                <h1 className="text-lg sm:text-xl font-bold">Симулятор инвестора «Мой первый портфель»</h1>
              </div>
              <nav className="hidden md:flex gap-3 text-sm">
                <button onClick={()=>setTab('market')}  className="px-3 py-1.5 rounded-xl border hover:bg-gray-100">Котировки</button>
                <button onClick={()=>setTab('sim')}      className="px-3 py-1.5 rounded-xl border hover:bg-gray-100">Портфель</button>
                <button onClick={()=>setTab('learn')}    className="px-3 py-1.5 rounded-xl border hover:bg-gray-100">Обучение</button>
                <button onClick={()=>setTab('quiz')}     className="px-3 py-1.5 rounded-xl border hover:bg-gray-100">Тест (20)</button>
              </nav>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-6 space-y-8">
            {/* Блок уведомлений */}
            <div className="bg-amber-50 border border-amber-200 rounded-2xl p-3 text-sm text-amber-800">
              Источник цен: <b>MOEX ISS</b> (публичный JSON, CORS открыт). Ссылки «Открыть» ведут на карточки <b>БКС Мир инвестиций</b>.
            </div>

            {tab==='market' && (
              <section className="bg-white rounded-2xl shadow border p-4">
                <div className="flex items-end justify-between mb-3">
                  <div>
                    <h2 className="font-semibold text-lg">ТОП-10 компаний РФ · реальные котировки</h2>
                    <div className="text-xs text-gray-600">Обновите срез в любой момент</div>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={loadPrices} className="px-3 py-1.5 rounded-xl border text-sm hover:bg-gray-100" disabled={loading}>
                      {loading? 'Обновляю…':'Обновить цены'}
                    </button>
                    <div className="text-xs text-gray-500 self-center">Обновлено: {asOf||'—'}</div>
                  </div>
                </div>
                {err && <div className="text-sm text-rose-600 mb-2">{err}</div>}
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="text-left text-gray-600">
                        <th className="py-2">№</th>
                        <th className="py-2">Компания</th>
                        <th className="py-2">Тикер</th>
                        <th className="py-2">Цена, ₽</th>
                        <th className="py-2">Изм., %</th>
                        <th className="py-2">БКС</th>
                      </tr>
                    </thead>
                    <tbody>
                      {quotes.map((q,i)=>(
                        <tr key={q.secid} className="border-t">
                          <td className="py-2 w-10">{i+1}</td>
                          <td className="py-2">{q.name}</td>
                          <td className="py-2 font-mono">{q.secid}</td>
                          <td className="py-2">{q.last!=null? q.last.toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2}) : '—'}</td>
                          <td className={`py-2 ${Number(q.chgPct)>=0?'text-emerald-600':'text-rose-600'}`}>{q.chgPct!=null? q.chgPct.toFixed(2):'—'}</td>
                          <td className="py-2"><a href={q.bcs} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline">Открыть</a></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </section>
            )}

            {tab==='sim' && (
              <section className="grid lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 bg-white border rounded-2xl p-4 shadow">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="font-semibold text-lg">Портфельный симулятор (на этих 10 бумагах)</h2>
                    <div className="flex gap-2">
                      <button onClick={()=>setRunning(r=>!r)} className="px-3 py-1.5 rounded-xl border text-sm hover:bg-gray-100">
                        {running? 'Пауза рынка':'Старт рынка'}
                      </button>
                      <button onClick={resetSim} className="px-3 py-1.5 rounded-xl border text-sm hover:bg-gray-100">Сброс</button>
                    </div>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="min-w-full text-sm">
                      <thead>
                        <tr className="text-left text-gray-600">
                          <th className="py-2">Тикер</th><th className="py-2">Компания</th><th className="py-2">Цена</th><th className="py-2">Кол-во</th><th className="py-2">Действия</th>
                        </tr>
                      </thead>
                      <tbody>
                        {sim.map(a => <Row key={a.secid} a={a} onTrade={trade}/>)}
                      </tbody>
                    </table>
                  </div>
                </div>

                <aside className="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
                    <div className="grid grid-cols-2 gap-2 text-sm">
                        <Stat label="Кэш" value={fmtCur(cash)} />
                        <Stat label="Инвестировано" value={fmtCur(equity)} />
                        <Stat label="Стоимость" value={fmtCur(total)} />
                        <Stat label="Доходность" value={ret} isReturn />
                    </div>

                     {/* линия стоимости портфеля */}
                    <Sparkline title="Стоимость портфеля" value={total} />

                     {/* круговая диаграмма структуры портфеля */}
                    <Donut positions={Object.entries(pos).map(([secid,p])=>({
                        label: secid,
                        value: p.qty * (sim.find(a=>a.secid===secid)?.price || 0)
                    }))} />

                    <button onClick={exportCSV} className="w-full px-3 py-2 rounded-xl border text-sm hover:bg-gray-100">
                        Экспорт портфеля (CSV)
                    </button>
                </aside>
              </section>
            )}

            {tab === 'learn' && (
                <section className="bg-white rounded-2xl shadow border p-4 space-y-3">
                    <h2 className="font-semibold text-lg">Обучающий блок (краткий конспект)</h2>

                    {/* 1 */}
                    <details className="border rounded-xl p-3">
                        <summary className="cursor-pointer font-medium">1. Рынок ценных бумаг — место в экономике</summary>
                        <div className="mt-2 text-sm text-gray-700">
                        Сегменты: государственные, корпоративные, производные. 
                        Функции — перераспределение капитала, ценообразование, ликвидность.
                    </div>
                    <div className="mt-3">
                        <iframe width="560" height="315"
                            src="https://rutube.ru/play/embed/cd1c8581ec46dae4bc107198fef61d86/"
                            frameBorder="0"
                            allow="clipboard-write; autoplay; encrypted-media; picture-in-picture"
                            allowFullScreen>
                        </iframe>
                    </div>
                </details>

                    {/* 2 */}
                    <details className="border rounded-xl p-3">
                        <summary className="cursor-pointer font-medium">2. Виды ценных бумаг</summary>
                        <div className="mt-2 text-sm text-gray-700">
                            Акции (обыкн./преф.), облигации, ETF, депозитарные расписки. 
                            Реквизиты и особенности обращения.
                        </div>
                        <div className="mt-3">
                            <iframe width="560" height="315"
                                src="https://rutube.ru/play/embed/8f569fcc93df9aefa3cdebc16e8a4857/"
                                frameBorder="0"
                                allow="clipboard-write; autoplay; encrypted-media; picture-in-picture"
                                allowFullScreen>
                        </iframe>
                    </div>
                </details>

                    {/* 3 */}
                    <details className="border rounded-xl p-3">
                        <summary className="cursor-pointer font-medium">3. Участники рынка</summary>
                        <div className="mt-2 text-sm text-gray-700">
                            Эмитенты, инвесторы, брокеры, котировальные списки, маркет-мейкеры, биржа и НКО НКЦ.
                        </div>
                        <div className="mt-3">
                            <iframe width="560" height="315"
                                src="https://rutube.ru/play/embed/255b7bde3fcb276bae2bcd3670a712fc/"
                                frameBorder="0"
                                allow="clipboard-write; autoplay; encrypted-media; picture-in-picture"
                                allowFullScreen>
                        </iframe>
                    </div>
                </details>


                    {/* 4 */}
                    <details className="border rounded-xl p-3">
                        <summary className="cursor-pointer font-medium">4. Биржа, сделки T+, индексы</summary>
                        <div className="mt-2 text-sm text-gray-700">
                            Котировка, курс, индексы IMOEX/RTS, клиринг T+2, лоты и ликвидность, Bid-Ask спред.
                        </div>
                        <div className="mt-3 space-y-4">
                            {/* Первое видео */}
                            <iframe width="560" height="315"
                                src="https://rutube.ru/play/embed/f788372f67a0ca2797ee742326c7c6fa/"
                                frameBorder="0"
                                allow="clipboard-write; autoplay; encrypted-media; picture-in-picture"
                                allowFullScreen>
                            </iframe>

                            {/* Второе видео */}
                            <iframe width="560" height="315"
                                src="https://rutube.ru/play/embed/443285eb03d1b3ec8e0edad0e6d1dc9d/"
                                frameBorder="0"
                                allow="clipboard-write; autoplay; encrypted-media; picture-in-picture"
                                allowFullScreen>
                            </iframe>
                        </div>
                </details>
            </section>
        )}

        {tab === 'quiz' && (
          <section className="bg-white rounded-2xl shadow border p-4 space-y-4">
              <div className="flex items-center justify-between gap-4">
                <h2 className="font-semibold text-lg">Тест по теме (20 вопросов)</h2>
                <div className="w-48"><Progress value={progress} /></div>
              </div>

              {/* Список вопросов */}
              <div>
                {QUIZ.map((item, idx) => (
                  <Q
                    key={idx}
                    item={item}
                    idx={idx}
                    value={answers[idx]}
                    onChange={(v) =>
                      setAnswers((a) => {
                        const b = [...a];
                        b[idx] = v;
                        return b;
                      })
                    }
                  />
                ))}
              </div>

        {/* Панель действий / результат */}
        <div className="flex flex-wrap items-center gap-2">
          <button
            onClick={() => setShowResult(true)}
            className="px-3 py-1.5 rounded-xl border hover:bg-gray-100"
        >
          Проверить
        </button>
        <button
          onClick={exportQuiz}
          className="px-3 py-1.5 rounded-xl border hover:bg-gray-100"
        >
          Экспорт результата (TXT)
        </button>

        <div className="text-sm text-gray-600 ml-auto">
          Заполнено: {progress}%{" "}
          {showResult && (
            <span className="ml-3">
              Результат: <b>{correctCount}/{QUIZ.length}</b> — {grade(correctCount/QUIZ.length)}
            </span>
          )}
        </div>
      </div>
    </section>
  )}

          </main>

          <footer className="text-center text-xs text-gray-500 pb-6">
            © {new Date().getFullYear()} Образовательный симулятор.
          </footer>
        </div>
      );
    }

    /* ===================== Вспомогательные компоненты ===================== */
    function TabLink({id,tab,setTab,children}){
      const active = tab===id;
      return (
        <button onClick={()=>setTab(id)}
                className={`px-3 py-1.5 rounded-xl border text-sm ${active?'bg-gray-100 border-gray-300':'hover:bg-gray-100'}`}>
          {children}
        </button>
      );
    }
   function Stat({label, value, emphasize, isReturn}) {
     let cls = "text-gray-900";
     let display = value;

    if (isReturn) {
        const num = Number(value);   // сюда прилетает число ret
        display = (num >= 0 ? "+" : "") + (num * 100).toFixed(2) + "%";
        cls = num >= 0 ? "text-emerald-600" : "text-rose-600";
    } else if (emphasize) {
        cls = "text-emerald-600";
    }

  return (
    <div className="bg-gray-50 rounded-xl p-3 border">
      <div className="text-gray-600 text-xs">{label}</div>
      <div className={`text-sm font-semibold ${cls}`}>{display}</div>
    </div>
  );
}
    function Row({a,onTrade}){
      const [qty,setQty]=React.useState(10);
      return (
        <tr className="border-t">
          <td className="py-2 font-mono">{a.secid}</td>
          <td className="py-2">{a.name}</td>
          <td className="py-2">{a.price.toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
          <td className="py-2">
            <input type="number" min={1} value={qty} onChange={e=>setQty(Math.max(1,Number(e.target.value)||1))}
                   className="w-24 border rounded-xl px-2 py-1"/>
          </td>
          <td className="py-2">
            <div className="flex gap-2">
              <button className="px-3 py-1 rounded-xl border hover:bg-gray-100" onClick={()=>onTrade(a.secid,'buy',qty)}>Купить</button>
              <button className="px-3 py-1 rounded-xl border hover:bg-gray-100" onClick={()=>onTrade(a.secid,'sell',qty)}>Продать</button>
            </div>
          </td>
        </tr>
      );
    }
    function Sparkline({title,value}){
      const [pts,setPts]=React.useState(()=> Array.from({length:40},(_,i)=>({x:i,y:value})));
      React.useEffect(()=>{
        const id=setInterval(()=>{
          setPts(prev=>{
            const last=prev[prev.length-1]; const next={x:last.x+1,y:value};
            return [...prev.slice(1),next];
          });
        },1200);
        return ()=>clearInterval(id);
      },[value]);
      const w=260,h=60,pad=6, ys=pts.map(p=>p.y);
      const min=Math.min(...ys), max=Math.max(...ys)||1;
      const sx=i=>pad+(i/(pts.length-1))*(w-2*pad);
      const sy=y=>h-pad-((y-min)/Math.max(1e-9,(max-min)))*(h-2*pad);
      const d=pts.map((p,i)=>(i?'L':'M')+sx(i)+' '+sy(p.y)).join(' ');
      return (
        <div className="bg-gray-50 rounded-xl p-3 border">
          <div className="text-xs text-gray-600">{title}</div>
          <svg width={w} height={h}><path d={d} fill="none" stroke="currentColor" strokeWidth="1.5"/></svg>
        </div>
      );
    }
    function Donut({positions}){
  const data = positions.filter(p=>p.value>0);
  const total = data.reduce((s,x)=>s+x.value,0)||1;
  const size=200, stroke=34, r=(size-stroke)/2, cx=size/2, cy=size/2;

  // Палитра (Tailwind-цвета)
  const COLORS = [
    "#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6",
    "#06b6d4","#84cc16","#f97316","#e11d48","#14b8a6"
  ];

  let a0=0;
  const arcs = data.map((d,i)=>{
    const a1 = a0 + d.value/total*2*Math.PI;
    const color = COLORS[i % COLORS.length];
    const res = {a0, a1, label:d.label, color, val:d.value};
    a0 = a1;
    return res;
  });

  const arc = (a0,a1) => {
    const large = a1-a0>Math.PI ? 1 : 0;
    const x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0);
    const x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1);
    return `M ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1}`;
  };

  return (
    <div className="bg-gray-50 rounded-xl p-3 border">
      <div className="text-xs text-gray-600 mb-2">Структура портфеля</div>
      <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="mx-auto">
        {/* фон */}
        <circle cx={cx} cy={cy} r={r} fill="none" stroke="#e5e7eb" strokeWidth={stroke}/>
        {/* сегменты */}
        {arcs.map((s,i)=>(
          <path key={i}
            d={arc(s.a0,s.a1)}
            strokeWidth={stroke}
            stroke={s.color}
            strokeLinecap="butt"
            fill="none">
            <title>{`${s.label}: ${(s.val/total*100).toFixed(1)}%`}</title>
          </path>
        ))}
      </svg>

      {/* легенда */}
      <div className="mt-2 grid grid-cols-2 gap-1 text-xs text-gray-700">
        {arcs.map((s,i)=>(
          <div key={i} className="flex items-center gap-2">
            <span style={{background:s.color}} className="inline-block w-3 h-3 rounded"></span>
            <span>{s.label}</span>
            <span className="ml-auto text-gray-500">{(s.val/total*100).toFixed(1)}%</span>
          </div>
        ))}
      </div>
    </div>
  );
}
    function Unit({title,children}){ return (
      <details className="border rounded-xl p-3">
        <summary className="cursor-pointer font-medium">{title}</summary>
        <div className="text-sm text-gray-700 mt-2">{children}</div>
      </details>
    );}
    function Progress({value}){ return (
      <div className="h-2 rounded-full bg-gray-200 overflow-hidden">
        <div className="h-full bg-emerald-500" style={{width:`${value}%`}}></div>
      </div>
    );}
    function Q({item,idx,value,onChange}){
      return (
        <div className="py-3">
          <div className="font-medium">{idx+1}. {item.q}</div>
          <div className="mt-1 grid sm:grid-cols-2 gap-2">
            {item.a.map((t,i)=>(
              <label key={i} className={`flex items-center gap-2 border rounded-xl p-2 cursor-pointer ${value===i?'bg-emerald-50 border-emerald-300':'hover:bg-gray-50'}`}>
                <input type="radio" name={`q${idx}`} checked={value===i} onChange={()=>onChange(i)}/>
                <span className="text-sm">{t}</span>
              </label>
            ))}
          </div>
        </div>
      );
    }
    function grade(p){
      if(p>=0.9) return "отлично";
      if(p>=0.75) return "хорошо";
      if(p>=0.6) return "удовлетворительно";
      return "нужно повторить материал";
    }

    // Монтирование приложения
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>