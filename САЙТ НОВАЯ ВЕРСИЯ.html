<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Мой первый портфель — ТОП-10 MOEX + Симулятор</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React из CDN + Babel для JSX без сборки -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const TICKERS = [
      { secid: "SBER", name: "Сбербанк", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/sber" },
      { secid: "ROSN", name: "Роснефть", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/rosn" },
      { secid: "LKOH", name: "Лукойл", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/lkoh" },
      { secid: "NVTK", name: "Новатэк", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/nvtk" },
      { secid: "GAZP", name: "Газпром", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/gazp" },
      { secid: "PLZL", name: "Полюс", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/plzl" },
      { secid: "SIBN", name: "Газпром нефть", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/sibn" },
      { secid: "GMKN", name: "Норникель", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/gmkn" },
      { secid: "YDEX", name: "Яндекс", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/ydex" },
      { secid: "TATN", name: "Татнефть", bcs: "https://bcs-express.ru/kotirovki-i-grafiki/tatn" }
    ];

    const fmtCur = n => n.toLocaleString('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:2});
    const fmtPct = x => (x>=0?'+':'') + (x*100).toFixed(2) + '%';

    function randn(){ // Бокса–Мюллера
      let u=0,v=0; while(!u)u=Math.random(); while(!v)v=Math.random();
      return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
    }

    function App(){
      const [asOf, setAsOf] = React.useState('');
      const [err, setErr] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      // Котировки MOEX
      const [quotes, setQuotes] = React.useState(TICKERS.map(t=>({...t, last:null, chgPct:null})));
      // Симулятор
      const [running, setRunning] = React.useState(true);
      const [cash, setCash] = React.useState(100_000);
      const [pos, setPos] = React.useState({}); // { SBER:{qty, avg} }
      const [sim, setSim] = React.useState([]); // [{secid, name, price, vol, path:[]}, ...]

      const equity = React.useMemo(()=>{
        return sim.reduce((s,a)=> s + ((pos[a.secid]?.qty||0) * a.price), 0);
      },[sim,pos]);
      const total = cash + equity;
      const ret = (total - 100_000) / 100_000;

      // Загрузка реальных цен с MOEX ISS
      async function loadPrices(){
        try{
          setLoading(true); setErr('');
          const list = TICKERS.map(t=>t.secid).join(',');
          const url = `https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities.json?iss.meta=off&iss.only=marketdata,securities&securities=${list}`;
          const r = await fetch(url, { cache:'no-store' });
          if(!r.ok) throw new Error('HTTP '+r.status);
          const j = await r.json();
          const cols = j.marketdata.columns;
          const data = j.marketdata.data;
          const iSEC=cols.indexOf('SECID'), iLAST=cols.indexOf('LAST'),
                iPCT=cols.indexOf('LASTCHANGEPRCNT'), iLTPR=cols.indexOf('LASTTOPREVPRICE');

          const map = new Map();
          for(const row of data){
            const sec = row[iSEC];
            const last = row[iLAST];
            const pct = iPCT>=0? row[iPCT] : (iLTPR>=0 && row[iLTPR]!=null? (row[iLTPR]-1)*100 : null);
            map.set(sec, { last, pct });
          }

          const q = TICKERS.map(t=> ({...t, last: map.get(t.secid)?.last ?? null, chgPct: map.get(t.secid)?.pct ?? null}));
          setQuotes(q);
          setAsOf(new Date().toLocaleString('ru-RU'));

          // Если симулятор ещё не инициализирован — создать активы с реальными старт-ценами
          setSim(prev=>{
            if(prev.length) return prev;
            return q.map(t=>{
              const p = t.last ?? 100;
              return { secid: t.secid, name: t.name, price: p, vol: 0.01, path: [{x:0,y:p}] };
            });
          });
        }catch(e){
          console.error(e);
          setErr('Не удалось получить котировки с MOEX ISS. Попробуйте ещё раз.');
        }finally{ setLoading(false); }
      }

      // Тик симулятора: мягко «дрейфуем» вокруг реальной цены
      React.useEffect(()=>{
        if(!running || sim.length===0) return;
        const id = setInterval(()=>{
          setSim(prev => prev.map(a=>{
            const maxDelta = 0.002; // ±0.2%
            const shock = (Math.random()*2 - 1) * maxDelta;
            const next = Math.max(0.01, a.price*(1+shock));
            const nextPath = [...a.path, {x:(a.path[a.path.length-1].x+1), y: next}].slice(-120);
            return {...a, price: +next.toFixed(2), path: nextPath};
          }));
        }, 1200);
        return ()=>clearInterval(id);
      },[running, sim.length]);

      React.useEffect(()=>{ loadPrices(); },[]);

      function trade(secid, side, qtyInput){
        const a = sim.find(x=>x.secid===secid);
        const qty = Math.max(1, Math.floor(Number(qtyInput)||1));
        if(!a) return;
        if(side==='buy'){
          const cost = qty * a.price;
          if(cost > cash) return;
          setCash(c=> c - cost);
          setPos(p=>{
            const cur = p[secid] || { qty:0, avg:a.price };
            const nqty = cur.qty + qty;
            const navg = (cur.qty*cur.avg + qty*a.price) / nqty;
            return {...p, [secid]: { qty:nqty, avg:+navg.toFixed(2) }};
          });
        }else{
          setPos(p=>{
            const cur = p[secid]; if(!cur || cur.qty<qty) return p;
            setCash(c=> c + qty*a.price);
            const nqty = cur.qty - qty;
            if(nqty===0){ const { [secid]:_, ...rest } = p; return rest; }
            return {...p, [secid]: { qty:nqty, avg:cur.avg }};
          });
        }
      }

      function exportCSV(){
        const rows=[["Тикер","Компания","Кол-во","Средняя","Текущая","Нереализ. P&L"]];
        sim.forEach(a=>{
          const p = pos[a.secid];
          if(p?.qty){
            const pnl = p.qty*(a.price-p.avg);
            rows.push([a.secid, a.name, p.qty, p.avg, a.price, pnl.toFixed(2)]);
          }
        });
        rows.push([]);
        rows.push(["Кэш", cash.toFixed(2)]);
        rows.push(["Инвестировано", equity.toFixed(2)]);
        rows.push(["Стоимость портфеля", total.toFixed(2)]);
        rows.push(["Доходность", (ret*100).toFixed(2)+"%"]);
        const csv = rows.map(r=> r.map(v=> `"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
        const blob = new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='portfolio_export.csv'; a.click();
        URL.revokeObjectURL(url);
      }

      return (
        <div className="min-h-screen">
          {/* HEADER */}
          <header className="bg-white border rounded-2xl p-4 shadow-sm max-w-6xl mx-auto mt-4">
            <div className="flex items-center justify-between gap-4">
              <div>
                <h1 className="text-xl font-bold">Симулятор инвестора «Мой первый портфель»</h1>
                <p className="text-xs text-gray-600">Котировки: MOEX ISS · Ссылки: БКС Мир инвестиций</p>
              </div>
              <div className="flex gap-2">
                <button onClick={loadPrices} className="px-3 py-1.5 rounded-xl border text-sm hover:bg-gray-100" disabled={loading}>
                  {loading? 'Обновляю…':'Обновить цены'}
                </button>
                <button onClick={()=>setRunning(r=>!r)} className="px-3 py-1.5 rounded-xl border text-sm hover:bg-gray-100">
                  {running? 'Пауза рынка':'Старт рынка'}
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-6 space-y-6">
            {/* КОТИРОВКИ */}
            <section className="bg-white border rounded-2xl p-4 shadow-sm">
              <div className="flex items-end justify-between mb-3">
                <h2 className="font-semibold text-lg">ТОП-10 компаний РФ · реальные котировки</h2>
                <div className="text-xs text-gray-600">Обновлено: {asOf || '—'}</div>
              </div>
              {err && <div className="text-sm text-rose-600 mb-2">{err}</div>}
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="text-left text-gray-600">
                      <th className="py-2">№</th>
                      <th className="py-2">Компания</th>
                      <th className="py-2">Тикер</th>
                      <th className="py-2">Цена, ₽</th>
                      <th className="py-2">Изм., %</th>
                      <th className="py-2">БКС</th>
                    </tr>
                  </thead>
                  <tbody>
                    {quotes.map((q,i)=>(
                      <tr key={q.secid} className="border-t">
                        <td className="py-2 w-10">{i+1}</td>
                        <td className="py-2">{q.name}</td>
                        <td className="py-2 font-mono">{q.secid}</td>
                        <td className="py-2">{q.last!=null? q.last.toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2}) : '—'}</td>
                        <td className={`py-2 ${Number(q.chgPct)>=0?'text-emerald-600':'text-rose-600'}`}>{q.chgPct!=null? q.chgPct.toFixed(2):'—'}</td>
                        <td className="py-2">
                          <a href={q.bcs} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline">Открыть</a>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>

            {/* СИМУЛЯТОР ПОРТФЕЛЯ */}
            <section className="grid lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 bg-white border rounded-2xl p-4 shadow-sm">
                <div className="flex items-center justify-between mb-2">
                  <h2 className="font-semibold text-lg">Симулятор портфеля (на базе этих 10 бумаг)</h2>
                  <span className="text-xs text-gray-600">Цены двигаются в демо-режиме вокруг последнего значения</span>
                </div>
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="text-left text-gray-600">
                        <th className="py-2">Тикер</th>
                        <th className="py-2">Компания</th>
                        <th className="py-2">Цена</th>
                        <th className="py-2">Кол-во</th>
                        <th className="py-2">Действия</th>
                      </tr>
                    </thead>
                    <tbody>
                      {sim.map((a,idx)=> <Row key={a.secid} a={a} onTrade={trade} />)}
                    </tbody>
                  </table>
                </div>
              </div>

              <aside className="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <Stat label="Кэш" value={fmtCur(cash)} />
                  <Stat label="Инвестировано" value={fmtCur(equity)} />
                  <Stat label="Стоимость" value={fmtCur(total)} />
                  <Stat label="Доходность" value={fmtPct(ret)} emphasize />
                </div>
                <Sparkline title="Стоимость портфеля" value={total} />
                <button onClick={exportCSV} className="w-full px-3 py-2 rounded-xl border text-sm hover:bg-gray-100">Экспорт в CSV</button>
              </aside>
            </section>

            {/* Обучение (кратко) */}
            <section className="bg-white border rounded-2xl p-4 shadow-sm">
              <h3 className="font-semibold mb-2">Обучающий блок</h3>
              <ul className="list-disc pl-6 text-sm text-gray-700 space-y-1">
                <li>Сегменты рынка ЦБ: гос., корп., производные.</li>
                <li>Виды ЦБ: акции, облигации, ETF/ДР; реквизиты и обращение.</li>
                <li>Индексы и сделки T+: котировка, курс, ликвидность.</li>
              </ul>
            </section>
          </main>

          <footer className="text-center text-xs text-gray-500 pb-6">
            © {new Date().getFullYear()} Учебный симулятор. Данные котировок: MOEX ISS (публичный JSON). Ссылки на БКС — для удобства студентов.
          </footer>
        </div>
      );
    }

    function Row({a,onTrade}){
      const [qty,setQty]=React.useState(10);
      return (
        <tr className="border-t">
          <td className="py-2 font-mono">{a.secid}</td>
          <td className="py-2">{a.name}</td>
          <td className="py-2">{a.price.toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
          <td className="py-2">
            <input type="number" min={1} value={qty} onChange={e=>setQty(Math.max(1,Number(e.target.value)||1))} className="w-24 border rounded-xl px-2 py-1"/>
          </td>
          <td className="py-2">
            <div className="flex gap-2">
              <button className="px-3 py-1 rounded-xl border hover:bg-gray-100" onClick={()=>onTrade(a.secid,'buy',qty)}>Купить</button>
              <button className="px-3 py-1 rounded-xl border hover:bg-gray-100" onClick={()=>onTrade(a.secid,'sell',qty)}>Продать</button>
            </div>
          </td>
        </tr>
      );
    }

    function Stat({label,value,emphasize}){
      return (
        <div className="bg-gray-50 rounded-xl p-3 border">
          <div className="text-gray-600 text-xs">{label}</div>
          <div className={`text-sm font-semibold ${emphasize?'text-emerald-600':'text-gray-900'}`}>{value}</div>
        </div>
      );
    }

    // Простой SVG-спарклайн стоимости портфеля
    function Sparkline({title, value}){
      const [pts,setPts]=React.useState(()=> Array.from({length:40},(_,i)=>({x:i,y:value})));
      React.useEffect(()=>{
        const id=setInterval(()=>{
          setPts(prev=>{
            const last = prev[prev.length-1];
            const next = {x:last.x+1, y:value};
            return [...prev.slice(1), next];
          });
        }, 1200);
        return ()=>clearInterval(id);
      },[value]);
      const w=260,h=60,pad=6;
      const ys = pts.map(p=>p.y);
      const min=Math.min(...ys), max=Math.max(...ys) || 1;
      const scaleX = i => pad + (i/(pts.length-1))*(w-2*pad);
      const scaleY = y => h-pad - ((y-min)/Math.max(1e-9,(max-min)))*(h-2*pad);
      const d = pts.map((p,i)=> (i? 'L':'M') + scaleX(i) + ' ' + scaleY(p.y)).join(' ');
      return (
        <div className="bg-gray-50 rounded-xl p-3 border">
          <div className="text-xs text-gray-600">{title}</div>
          <svg width={w} height={h}>
            <path d={d} fill="none" stroke="currentColor" strokeWidth="1.5" />
          </svg>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
